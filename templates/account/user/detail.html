{% extends "base.html" %}
{% load blog_tags %}
{% load thumbnail %}

{% block title %}{{ user|get_user_full_name }}{% endblock %}

{% block content %}
    <h1>{{ user|get_user_full_name }}</h1>
    <div style="height: 250px">
        <div class="profile-info">
            {% thumbnail user.profile.photo "180x180" crop="100%" as im %}
                <img src="{{ im.url }}" class="user-detail">
            {% endthumbnail %}
        </div>
        {% with total_followers=user.followers.count %}
            <span class="count">
            <span class="total">подписчики: {{ total_followers }}</span>
{#            follower{{ total_followers|pluralize }}#}
        </span>
            <span class="count">
            <span>статьи: {{ user|get_user_published_posts_count }}</span>
{#            article{{ user.created_posts.count|pluralize }}#}
        </span>
            {# В HTML-элемент <a> добавлены атрибуты data-id и data-action, которые содержат ID открытого профиля и действие follow        #}
            {# или unfollow, доступное текущему пользователю. Также на странице показаны картинки, которые пользователь добавил в закладки #}
            {% if request.user.is_authenticated and request.user.id != user.id %}
                <a href="#" data-id="{{ user.id }}"
                   data-action="{% if request.user in user.followers.all %}un{% endif %}follow"
                   class="follow button">
                    {% if request.user not in user.followers.all %}
                        Follow
                    {% else %}
                        Unfollow
                    {% endif %}
                </a>
            {% endif %}
        {% endwith %}
    </div>

    {% if request.user|has_group:"Moderator" %}
        <div style="margin-bottom: 10px">
            <form action="." method="post" enctype="multipart/form-data">
                <div style="background-color: #ddffdd; padding: 10px 10px 10px 10px; width: 30%">
                    <h4 style="margin-block-start: 0em"></h4>
                    <input type="checkbox" name="group_publisher" id="group_publisher_id"
                           {% if user|has_group:"Publisher" %}checked{% endif %}>
                    <i>&nbsp;Publisher</i>
                    <br><br>
                    <input type="checkbox" name="group_publisher_with_grant" id="group_publisher_with_grant_id"
                           {% if user|has_group:"PublisherWithGrant" %}checked{% endif %}>
                    <i>&nbsp;PublisherWithGrant</i>
                    <br><br>
                    <input type="checkbox" name="group_moderator" id="group_moderator_id"
                           {% if user|has_group:"Moderator" %}checked{% endif %}>
                    <i>&nbsp;Moderator</i>
                </div>
                {% csrf_token %}
                <p><input type="submit" value="Save changes"></p>
            </form>
        </div>
    {% endif %}

    <div style="margin-bottom: 20px">
        <div>
            <h2 style="display: inline">Опубликованные статьи</h2>
            &nbsp&nbsp<a style="color: grey; float: right" href="{% url "blog" %}?author_id={{ user.id }}">
            <i>посмотреть все</i></a>
            <br><br>
        </div>
        {% for post in posts %}

            <div class="card shadow bg-white" style="margin-bottom: 10px; margin-top: 10px">
                <div class="card-body" style="background-color: #ddffdd; padding: 10px">
                    <h2 class="card-title" style="margin-top: 20px"><a
                            href="{% url 'post_detail' pk=post.pk %}">{{ post.title }}</a></h2>
                    <p class="card-text" style="margin-bottom: 5px;"> {{ post.body_summary|striptags }} </p>
                    <hr>
                    <div>
                        {% if post.tags %}
                            <b>теги:</b>&nbsp;
                        {% endif %}
                        {% for tag in post.tags %}
                            <a style="color: black"
                               href="{% url "blog" %}?tag_value={{ tag }}"
                            ><i>{{ tag }}</i></a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                        <div style="text-align: right;"><i>{{ post.created_date }}</i></div>
                    </div>
                </div>
            </div>
        {% empty %}
            <p>Пользователь еще не опубликовал ни одной статьи</p>
        {% endfor %}
    </div>

    <div>
        <div>
            <h2 style="display: inline">В избранном</h2>
            &nbsp&nbsp<a style="color: grey; float: right"
                         href="{% url "blog" %}?post_ids={{ user.profile.favorites }}">
            <i>посмотреть все</i></a>
            <br><br>
        </div>
        {% for post in favorites %}
            <div class="card shadow bg-white" style="margin-bottom: 10px; margin-top: 10px">
                <div class="card-body" style="background-color: #ddffdd; padding: 10px">
                    <h2 class="card-title" style="margin-top: 20px"><a
                            href="{% url 'post_detail' pk=post.pk %}">{{ post.title }}</a></h2>
                    <p class="card-text" style="margin-bottom: 5px;"> {{ post.body_summary|striptags }} </p>
                    <hr>
                    <div>
                        {% if post.tags %}
                            <b>теги:</b>&nbsp;
                        {% endif %}
                        {% for tag in post.tags %}
                            <a style="color: black"
                               href="{% url "blog" %}?tag_value={{ tag }}"
                            ><i>{{ tag }}</i></a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                        <div style="text-align: right;"><i>{{ post.created_date }}</i></div>
                    </div>
                </div>
            </div>
        {% empty %}
            <p>Пользователь еще не добавил в "Избранное" ни одной статьи</p>
        {% endfor %}
    </div>

{% endblock %}

{% block domready %}
    $('a.follow').click(function (e) {
    e.preventDefault();
    $.post('{% url "user_follow" %}',
    {
    id: $(this).data('id'),
    action: $(this).data('action')
    },
    function (data) {
    if (data['status'] == 'ok'){
    var previous_action = $('a.follow').data('action');

    // Изменяем действие на противоположное.
    $('a.follow').data('action',
    previous_action == 'follow' ? 'unfollow' : 'Follow');
    // Изменяем текст ссылки.
    $('a.follow').text(previous_action == 'follow' ? 'unfollow' : 'Follow');

    // Обновляем количество подписчиков.
    var defstr = 'подписчики: ';
    var now_str = $('span.count .total').text();
    previous_followers = parseInt(now_str.replace('подписчики: ', ''));
    alert(previous_followers);
    if(previous_action == 'follow'){
    now_followers = previous_followers + 1;
    } else {
    now_followers = previous_followers - 1;
    }
    $('span.count .total').text(
    defstr + now_followers
    );
    }
    }
    )
    }

    )
{% endblock %}
{# Этот JavaScript-код выполняет AJAX-запрос, чтобы добавить в подписчики или удалить из них текущего пользователя и  #}
{# изменить текст ссылки соответствующим образом. Мы используем jQuery для выполнения запроса и выставляем атрибут    #}
{# data-action и текст <a>-элемента, учитывая предыдущие значения. При успешном выполнении запроса обновляем          #}
{# количество подписчиков. #}